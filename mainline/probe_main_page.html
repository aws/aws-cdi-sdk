<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="https://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<title>CDI SDK: Connection Probe Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="image_left.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CDI SDK
   </div>
   <div id="projectbrief">SDK for transporting chunks of data reliably and with low latency using a polled mode network driver.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Connection Probe Architecture</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#probe_overview">Architecture Overview</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="probe_overview"></a>
Architecture Overview</h1>
<p>In order to establish an SRD connection between two EC2 instances using EFA adapters, a specific sequence of events must occur. The EC2 instance used as a transmitter must obtain an EFA device identifier of the remote EC2 instance in order to establish the EFA connection. Initial startup and optimization of the SRD network flows need to be established before the EFA connection can be used by the application. For this, a socket based interface is used to control communication. All requests contain information about the sender such as <a class="el" href="structCdiProtocolVersionNumber.html" title="CDI header used to identify protocol version number information.">CdiProtocolVersionNumber</a>, IP address, port and EFA device identifier. <a class="el" href="structCdiProtocolVersionNumber.html" title="CDI header used to identify protocol version number information.">CdiProtocolVersionNumber</a> is used to negotiate compatible probe and CDI-SDK protocols. In order to support legacy protocols, the negotiation process involves multiple steps and is described below:</p>
<ol type="1">
<li>Create the socket based control interface. The instances start in <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa58b62f015dce8b2b85caf0bafcec0848" title="Probe just started. Advance to kProbeStateSendReset.">kProbeStateIdle</a> and then advance to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afab57e41bee486c77d18c450cd499f574b">kProbeStateSendReset</a>.</li>
<li><p class="startli">Transmitter sends reset requests that contain protocol v1.0.x to receiver until an ACK is received. This value is used to allow backwards compatibility with legacy versions of the protocols. For legacy versions of the probe protocol, the value of "x" is ignored. For all other versions:</p>
<p class="startli">If the value of "x" (defined by CDI_PROBE_VERSION) is 3 or greater, then the probe protocol supports the new <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047ad314b1c1fe7d6975a6997dd0cf1bd53c" title="Packet contains protocol version of sender.">kProbeCommandProtocolVersion</a> command. Otherwise, the legacy protocol v1.0.x is used.</p>
</li>
<li>Once the receiver has received the reset request, non-legacy versions of the probe protocol examine the transmitter's CDI_PROBE_VERSION. If the value is 3 or greater than the ACK response will contain the receiver's CDI-SDK and probe version and wait for the transmitter to send the new <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047ad314b1c1fe7d6975a6997dd0cf1bd53c" title="Packet contains protocol version of sender.">kProbeCommandProtocolVersion</a> command. Otherwise, the receiver sets its negotiated protocol to legacy v1.0.x, which will be used for all future probe communication until another reset command is received or the connection is lost. In either case it advances the state to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afae2935cc6d803e291dc0ee610456332d7" title="Send a request to reset the connection to the Endpoint Manager and advance to the kProbeStateSendRese...">kProbeStateEfaReset</a>, using the Endpoint Manager to reset the local connection. While this is occurring, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa7334a382eded33e511a23c4743e4c6ff">kProbeStateResetting</a>. When complete, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa86f25f17ae210dab0b9de6ebabc928d7">kProbeStateResetDone</a>, which causes the ACK to be sent back to the transmitter. State then advances to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa1d26bfd9479671bd8fbd876f4d4673f8">kProbeStateEfaProbe</a>, which is used to transmit several SRD packets over the EFA interface to establish the initial network flows.</li>
<li><p class="startli">Once the transmitter has received the ACK for a reset request, for non-legacy probe protocols the receiver's probe protocol version is evaluated as described below:</p>
<p class="startli">If the probe protocol version is 3 or greater, then the state advances to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa4dd18d52563b249bcba97192a9d62071" title="After ACK from reset has been received by Tx, send protocol version to Rx.">kProbeStateSendProtocolVersion</a> and the <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047ad314b1c1fe7d6975a6997dd0cf1bd53c" title="Packet contains protocol version of sender.">kProbeCommandProtocolVersion</a> command is sent to the receiver. After the transmitter receives the ACK for <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047ad314b1c1fe7d6975a6997dd0cf1bd53c" title="Packet contains protocol version of sender.">kProbeCommandProtocolVersion</a>, it sets its negotiated CDI-SDK and probe protocol version. Otherwise, the transmitter sets its negotiated protocol to legacy v1.0.x.</p>
</li>
<li>After the transmitter's negotiated protocols have been set, the transmitter then uses the Endpoint Manager to prepare the EFA connection so it can be started. While this is occurring, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa2e368bcefadfca589571f57f838b07ee">kProbeStateWaitForStart</a>. When complete, the state is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa284f1421e459f43f938b687c8887c1fb">kProbeStateEfaStart</a>, which causes the connection to be started and begins transmitting SRD probe packets over the EFA interface. State is set to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa1d26bfd9479671bd8fbd876f4d4673f8">kProbeStateEfaProbe</a>.</li>
<li>After the desired number of SRD probe packets have been successfully transmitted and confirmed as being received by the receiver, the receiver will advance its state to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa85057fe072457bd73c728b73e69d9ad3">kProbeStateEfaConnected</a>, invoke the user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a>, and send <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047a935cbe9d2892b04c66bd17439c42417a" title="Notification that connection has been established (probe has completed).">kProbeCommandConnected</a> to the transmitter. After the transmitter receives the command, it advances the state to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afa85057fe072457bd73c728b73e69d9ad3">kProbeStateEfaConnected</a> and the user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a> is invoked.</li>
<li>While connected, the transmitter will send <a class="el" href="protocol_8h.html#aa548bed9cef20b3d1b13193db9add047a3514f095b18a18970932ae0c161d0a6d" title="Request to ping the connection.">kProbeCommandPing</a> commands using the control interface to the receiver to ensure both transmitter and receiver are operating correctly. This is done at a regular interval (<a class="el" href="configuration_8h.html#a8ebbc64bfbfcd914e18805c72fdf67d3" title="Once a connection has been established, this defines how often the transmitter sends a ping to comman...">SEND_PING_COMMAND_FREQUENCY_MSEC</a>). If the transmitter does not receive an ACK back within a timeout period (<a class="el" href="configuration_8h.html#a9deba3198864b8f87597d09400495a8b" title="This value is used by the transmitter to define how long it waits for an ACK response to a command th...">TX_COMMAND_ACK_TIMEOUT_MSEC</a>), a few more attempts are made. If these attempts fail, the transmitter disables the EFA connection and returns to <a class="el" href="adapter__efa__probe_8h.html#a58211ba239679a1e2fa61c3cbc71d3afab57e41bee486c77d18c450cd499f574b">kProbeStateSendReset</a> state.</li>
</ol>
<p>NOTE: The user registered callback function <a class="el" href="cdi__core__api_8h.html#a5ad508526ac5a4696c9816597664bac4" title="Prototype of connection callback function. The user code must implement a function with this prototyp...">CdiCoreConnectionCallback()</a> is invoked whenever the connection state changes (<a class="el" href="cdi__core__api_8h.html#a46b31bc48caec610070097d7e181a5bfae4b54a7bca3be5845816f264d3b082a1" title="Connected and ready for use.">kCdiConnectionStatusConnected</a> or <a class="el" href="cdi__core__api_8h.html#a46b31bc48caec610070097d7e181a5bfa411c891aa005c2309d03d604093bd2e8" title="Disconnected. The SDK is trying to establish the connection.">kCdiConnectionStatusDisconnected</a>).</p>
<p>The diagram shown below provides an overview of the connection probe architecture. </p><div class="image">
<img src="probe_high_level_architecture.jpg" alt=""/>
</div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
	<div>Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.</div>
</small></address>
</body>
</html>
